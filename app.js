// ===== MULTI-LANGUAGE PRESENTATION DATA =====
const translations = {
    en: {
        slides: [
            {
                text: "Virtual Twin of the Product\n\nAt OXOS, the virtual twin is not just a 3D model.\nIt is the single, complete, and living reference of the product.",
                media: null
            },
            {
                text: "It concentrates all the product's intelligence in one place:\ndetailed bill of materials, exact configurations, manufacturing constraints, engineering and certification data, material history.",
                media: "PRD 1"
            },
            {
                text: "Before a single machine is powered on, we already know the predicted cycle time, material costs, geometric risks, and even the environmental footprint.",
                media: "PRD 2"
            },
            {
                text: "This virtual twin feeds OXOS's generative AI.\nConcretely, for the manufacturing of a housing, OXOS automatically generates the optimal machining sequence, the associated 5-axis CNC program, and the relevant quality inspections to fits with A&D regulations.",
                media: "PRD 3"
            },
            {
                text: "In production, the virtual twin tracks progress, quality status, and process deviations in real time.\nIn engineering and compliance, it ensures full traceability — from as-specified to as-maintained — with certification reports generated automatically.",
                media: "PRD 4"
            },
            {
                text: "With OXOS, industry moves from reactive execution\nto a predictive process, continuously auditable.",
                media: "PRD Content"
            }
        ],
        buttons: {
            start: "Start Presentation",
            continue: "Continue",
            finish: "Finish",
            restart: "Restart Presentation"
        },
        endScreen: "<strong>Thank you</strong><br>Presentation Complete"
    },
    fr: {
        slides: [
            {
                text: "Jumeau Virtuel du Produit\n\nChez OXOS, le jumeau virtuel n'est pas qu'un modèle 3D.\nC'est la référence unique, complète et vivante du produit.",
                media: null
            },
            {
                text: "Il concentre toute l'intelligence du produit en un seul endroit :\nnomenclature détaillée, configurations exactes, contraintes de fabrication, données d'ingénierie et de certification, historique des matériaux.",
                media: "PRD 1"
            },
            {
                text: "Avant même qu'une seule machine ne soit mise sous tension, nous connaissons déjà le temps de cycle prévu, les coûts des matériaux, les risques géométriques et même l'empreinte environnementale.",
                media: "PRD 2"
            },
            {
                text: "Ce jumeau virtuel alimente l'IA générative d'OXOS.\nConcrètement, pour la fabrication d'un boîtier, OXOS génère automatiquement la séquence d'usinage optimale, le programme CNC 5 axes associé et les contrôles qualité pertinents conformes aux réglementations A&D.",
                media: "PRD 3"
            },
            {
                text: "En production, le jumeau virtuel suit en temps réel l'avancement, le statut qualité et les écarts de processus.\nEn ingénierie et conformité, il assure une traçabilité complète — du spécifié au maintenu — avec des rapports de certification générés automatiquement.",
                media: "PRD 4"
            },
            {
                text: "Avec OXOS, l'industrie passe d'une exécution réactive\nà un processus prédictif, continuellement auditable.",
                media: "PRD Content"
            }
        ],
        buttons: {
            start: "Démarrer la Présentation",
            continue: "Continuer",
            finish: "Terminer",
            restart: "Redémarrer la Présentation"
        },
        endScreen: "<strong>Merci</strong><br>Présentation Terminée"
    },
    es: {
        slides: [
            {
                text: "Gemelo Virtual del Producto\n\nEn OXOS, el gemelo virtual no es solo un modelo 3D.\nEs la referencia única, completa y viva del producto.",
                media: null
            },
            {
                text: "Concentra toda la inteligencia del producto en un solo lugar:\nlista de materiales detallada, configuraciones exactas, restricciones de fabricación, datos de ingeniería y certificación, historial de materiales.",
                media: "PRD 1"
            },
            {
                text: "Antes de encender una sola máquina, ya conocemos el tiempo de ciclo previsto, los costos de materiales, los riesgos geométricos e incluso la huella ambiental.",
                media: "PRD 2"
            },
            {
                text: "Este gemelo virtual alimenta la IA generativa de OXOS.\nConcretamente, para la fabricación de una carcasa, OXOS genera automáticamente la secuencia de mecanizado óptima, el programa CNC de 5 ejes asociado y las inspecciones de calidad relevantes conforme a las regulaciones A&D.",
                media: "PRD 3"
            },
            {
                text: "En producción, el gemelo virtual rastrea en tiempo real el progreso, el estado de calidad y las desviaciones del proceso.\nEn ingeniería y cumplimiento, garantiza una trazabilidad completa — desde lo especificado hasta lo mantenido — con informes de certificación generados automáticamente.",
                media: "PRD 4"
            },
            {
                text: "Con OXOS, la industria pasa de una ejecución reactiva\na un proceso predictivo, continuamente auditable.",
                media: "PRD Content"
            }
        ],
        buttons: {
            start: "Iniciar Presentación",
            continue: "Continuar",
            finish: "Finalizar",
            restart: "Reiniciar Presentación"
        },
        endScreen: "<strong>Gracias</strong><br>Presentación Completa"
    },
    de: {
        slides: [
            {
                text: "Virtueller Zwilling des Produkts\n\nBei OXOS ist der virtuelle Zwilling nicht nur ein 3D-Modell.\nEr ist die einzige, vollständige und lebendige Referenz des Produkts.",
                media: null
            },
            {
                text: "Er konzentriert die gesamte Intelligenz des Produkts an einem Ort:\ndetaillierte Stückliste, exakte Konfigurationen, Fertigungsbeschränkungen, Engineering- und Zertifizierungsdaten, Materialhistorie.",
                media: "PRD 1"
            },
            {
                text: "Bevor eine einzige Maschine eingeschaltet wird, kennen wir bereits die vorhergesagte Zykluszeit, Materialkosten, geometrische Risiken und sogar den ökologischen Fußabdruck.",
                media: "PRD 2"
            },
            {
                text: "Dieser virtuelle Zwilling speist die generative KI von OXOS.\nKonkret generiert OXOS für die Herstellung eines Gehäuses automatisch die optimale Bearbeitungssequenz, das zugehörige 5-Achs-CNC-Programm und die relevanten Qualitätsprüfungen gemäß A&D-Vorschriften.",
                media: "PRD 3"
            },
            {
                text: "In der Produktion verfolgt der virtuelle Zwilling in Echtzeit Fortschritt, Qualitätsstatus und Prozessabweichungen.\nIm Engineering und Compliance gewährleistet er vollständige Rückverfolgbarkeit — von der Spezifikation bis zur Wartung — mit automatisch generierten Zertifizierungsberichten.",
                media: "PRD 4"
            },
            {
                text: "Mit OXOS bewegt sich die Industrie von reaktiver Ausführung\nzu einem prädiktiven Prozess, der kontinuierlich überprüfbar ist.",
                media: "PRD Content"
            }
        ],
        buttons: {
            start: "Präsentation Starten",
            continue: "Weiter",
            finish: "Beenden",
            restart: "Präsentation Neustarten"
        },
        endScreen: "<strong>Vielen Dank</strong><br>Präsentation Abgeschlossen"
    },
    zh: {
        slides: [
            {
                text: "产品虚拟孪生\n\n在OXOS，虚拟孪生不仅仅是一个3D模型。\n它是产品唯一、完整且动态的参考。",
                media: null
            },
            {
                text: "它将产品的所有智能集中在一个地方：\n详细的物料清单、精确的配置、制造约束、工程和认证数据、材料历史。",
                media: "PRD 1"
            },
            {
                text: "在启动任何一台机器之前，我们已经知道预测的周期时间、材料成本、几何风险，甚至环境足迹。",
                media: "PRD 2"
            },
            {
                text: "这个虚拟孪生为OXOS的生成式AI提供动力。\n具体来说，对于外壳的制造，OXOS会自动生成最优的加工序列、相关的5轴CNC程序，以及符合航空航天和国防法规的相关质量检查。",
                media: "PRD 3"
            },
            {
                text: "在生产中，虚拟孪生实时跟踪进度、质量状态和流程偏差。\n在工程和合规性方面，它确保完整的可追溯性——从规定到维护——自动生成认证报告。",
                media: "PRD 4"
            },
            {
                text: "借助OXOS，工业从被动执行\n转向可持续审计的预测性流程。",
                media: "PRD Content"
            }
        ],
        buttons: {
            start: "开始演示",
            continue: "继续",
            finish: "完成",
            restart: "重新开始演示"
        },
        endScreen: "<strong>谢谢</strong><br>演示完成"
    }
};

// ===== STATE MANAGEMENT =====
let currentSlide = -1; // Start at -1 to show intro
let activeMedia = null; // Track currently visible media
let soundStarted = false; // Track if PRD Sound has been shown
let currentLanguage = 'en'; // Default language (each user can change independently)

// ===== SUPABASE REAL-TIME SYNC =====
let supabaseClient = null;
let realtimeChannel = null;
let sessionId = null; // Current session ID
let isLocalAction = false; // Flag to prevent loops

// Get current slides based on selected language
function getSlides() {
    return translations[currentLanguage].slides;
}

function getButtonText(key) {
    return translations[currentLanguage].buttons[key];
}

function getEndScreenText() {
    return translations[currentLanguage].endScreen;
}

// ===== SDK INTEGRATION =====
// Function to send visibility messages to the SDK platform
function toggleVisibility(actorName, visible) {
    console.log("toggleVisibility:", actorName, visible);
    window.parent.postMessage(JSON.stringify({
        action: "toggleVisibility",
        actor: actorName,
        visible: visible
    }), "*");
}

// Function to show 3D media
function showMedia(mediaName) {
    if (mediaName) {
        toggleVisibility(mediaName, true);
        activeMedia = mediaName;
        console.log(`Showing 3D object: ${mediaName}`);
    }
}

// Function to hide 3D media
function hideMedia(mediaName) {
    if (mediaName) {
        toggleVisibility(mediaName, false);
        console.log(`Hiding 3D object: ${mediaName}`);
    }
}

// Function to hide all media
function hideAllMedia() {
    const allMedia = ["PRD 1", "PRD 2", "PRD 3", "PRD 4", "PRD Content"];
    allMedia.forEach(media => {
        toggleVisibility(media, false);
    });
    activeMedia = null;
    console.log("All 3D objects hidden");
}

// Function to hide AS IS Product only when presentation starts
function hideASISProduct() {
    toggleVisibility("AS IS Product", false);
    console.log("AS IS Product hidden");
}

// ===== LANGUAGE SELECTOR =====
function changeLanguage(lang) {
    currentLanguage = lang;
    console.log('Language changed to:', lang);

    // Update current slide text
    if (currentSlide >= 0 && currentSlide < getSlides().length) {
        const slideText = document.querySelector('.slide-text');
        slideText.textContent = getSlides()[currentSlide].text;
    }

    // Update button text
    const nextBtn = document.getElementById('nextBtn');
    const btnText = nextBtn.querySelector('.btn-text');

    if (currentSlide === -1) {
        btnText.textContent = getButtonText('start');
    } else if (currentSlide === getSlides().length - 1) {
        btnText.textContent = getButtonText('finish');
    } else if (currentSlide >= getSlides().length) {
        btnText.textContent = getButtonText('restart');
    } else {
        btnText.textContent = getButtonText('continue');
    }

    // Update language selector buttons
    document.querySelectorAll('.lang-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.lang === lang);
    });
}

// ===== INITIALIZATION =====
document.addEventListener('DOMContentLoaded', async () => {
    initStars();
    await initSupabase();
    initPresentation();
    initLanguageSelector();

    console.log("OXOS Presentation loaded - SDK ready");
    console.log("Supabase Real-time sync enabled - User ID:", window.USER_ID);
});

// ===== STARS CREATION =====
function initStars() {
    const starsContainer = document.getElementById('stars');
    const starCount = 150;

    for (let i = 0; i < starCount; i++) {
        const star = document.createElement('div');
        star.className = 'star';

        const size = Math.random() * 2 + 0.5;
        star.style.width = size + 'px';
        star.style.height = size + 'px';
        star.style.left = Math.random() * 100 + '%';
        star.style.top = Math.random() * 100 + '%';
        star.style.animationDelay = Math.random() * 3 + 's';
        star.style.animationDuration = (Math.random() * 2 + 2) + 's';

        starsContainer.appendChild(star);
    }
}

// ===== LANGUAGE SELECTOR INITIALIZATION =====
function initLanguageSelector() {
    const languageSelector = document.getElementById('languageSelector');

    // Add event listeners to language buttons
    languageSelector.querySelectorAll('.lang-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            changeLanguage(btn.dataset.lang);
        });
    });
}

// ===== PRESENTATION LOGIC =====
function initPresentation() {
    const nextBtn = document.getElementById('nextBtn');
    const textContent = document.getElementById('textContent');

    // Hide all PRD media at start (but NOT AS IS Product yet)
    hideAllMedia();

    // Hide PRD Sound initially
    toggleVisibility("PRD Sound", false);

    // Show intro state
    setTimeout(() => {
        textContent.classList.add('show');
        nextBtn.classList.add('show');
    }, 300);

    // Next button click handler
    nextBtn.addEventListener('click', nextSlide);

    // Update progress
    updateProgress();
}

async function nextSlide() {
    // Update Supabase to sync with all clients
    if (!isLocalAction) {
        await updateSession({ current_slide: currentSlide + 1 });
    }

    nextSlideLocal();
}

function nextSlideLocal() {
    const textContent = document.getElementById('textContent');
    const slideText = textContent.querySelector('.slide-text');
    const nextBtn = document.getElementById('nextBtn');

    // On first click, show PRD Sound
    if (!soundStarted) {
        toggleVisibility("PRD Sound", true);
        soundStarted = true;
    }

    // Don't hide previous media - keep them visible!
    // Each new media adds to the scene

    // Move to next slide
    currentSlide++;

    // Check if presentation is complete
    if (currentSlide >= getSlides().length) {
        // End of presentation
        showEndScreen();
        return;
    }

    // Animate out current text
    textContent.classList.remove('show');
    textContent.classList.add('slide-out');

    setTimeout(() => {
        // Update text content with current language
        const slide = getSlides()[currentSlide];
        slideText.textContent = slide.text;

        // Show new media if present (without hiding previous ones)
        if (slide.media) {
            showMedia(slide.media);

            // Hide AS IS Product when showing PRD Content (last media)
            if (slide.media === "PRD Content") {
                hideASISProduct();
            }
        }

        // Animate in new text
        textContent.classList.remove('slide-out');
        textContent.classList.add('slide-in');

        setTimeout(() => {
            textContent.classList.remove('slide-in');
            textContent.classList.add('show');
        }, 100);

        // Update button text based on language
        if (currentSlide === getSlides().length - 1) {
            nextBtn.querySelector('.btn-text').textContent = getButtonText('finish');
        } else {
            nextBtn.querySelector('.btn-text').textContent = getButtonText('continue');
        }

        // Update progress
        updateProgress();
    }, 500);
}

function showEndScreen() {
    const textContent = document.getElementById('textContent');
    const slideText = textContent.querySelector('.slide-text');
    const nextBtn = document.getElementById('nextBtn');

    // Animate out
    textContent.classList.remove('show');
    nextBtn.classList.remove('show');

    setTimeout(() => {
        slideText.innerHTML = getEndScreenText();

        textContent.classList.add('show');

        // Change button to restart
        nextBtn.querySelector('.btn-text').textContent = getButtonText('restart');
        nextBtn.querySelector('.btn-icon').textContent = '↻';
        nextBtn.onclick = restartPresentation;

        setTimeout(() => {
            nextBtn.classList.add('show');
        }, 500);
    }, 600);
}

async function restartPresentation() {
    // Update Supabase to sync with all clients
    if (!isLocalAction) {
        await updateSession({ current_slide: -1 });
    }

    restartPresentationLocal();
}

function restartPresentationLocal() {
    // Hide all media
    hideAllMedia();

    // Show AS IS Product again when restarting
    toggleVisibility("AS IS Product", true);

    // Hide PRD Sound when restarting (it will show on first click)
    toggleVisibility("PRD Sound", false);

    // Reset state
    currentSlide = -1;
    soundStarted = false;

    // Reset button
    const nextBtn = document.getElementById('nextBtn');
    nextBtn.querySelector('.btn-text').textContent = getButtonText('start');
    nextBtn.querySelector('.btn-icon').textContent = '→';
    nextBtn.onclick = nextSlide;

    // Reset content
    const textContent = document.getElementById('textContent');
    const slideText = textContent.querySelector('.slide-text');
    slideText.textContent = '';

    // Update progress
    updateProgress();

    console.log("Presentation restarted");
}

function updateProgress() {
    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('progressText');

    const total = getSlides().length;
    const current = Math.max(0, currentSlide + 1);
    const percentage = (current / total) * 100;

    // Simpler approach - directly set width via inline style
    const barFill = document.createElement('div');
    barFill.style.cssText = `
        position: absolute;
        top: 0;
        left: 0;
        height: 100%;
        width: ${percentage}%;
        background: linear-gradient(90deg, #1976d2, #4da6ff);
        border-radius: 10px;
        transition: width 0.6s ease;
        box-shadow: 0 0 10px rgba(77, 166, 255, 0.8);
    `;

    // Clear and add new fill
    progressBar.innerHTML = '';
    progressBar.appendChild(barFill);

    // Update text
    progressText.textContent = `${current} / ${total}`;
}

// ===== SUPABASE INITIALIZATION =====
async function initSupabase() {
    // Initialize Supabase client using the global supabase object from CDN
    const { createClient } = supabase;
    supabaseClient = createClient(window.SUPABASE_URL, window.SUPABASE_ANON_KEY);

    // Get or create the oxos presentation session (should be only one row)
    const { data, error } = await supabaseClient
        .from('oxos_presentation_session')
        .select('*')
        .single();

    if (error) {
        console.error('Error fetching OXOS presentation session:', error);
        return;
    }

    sessionId = data.id;
    console.log('Connected to OXOS presentation session:', sessionId);

    // Subscribe to real-time changes
    realtimeChannel = supabaseClient
        .channel('oxos_presentation_session_changes')
        .on(
            'postgres_changes',
            {
                event: 'UPDATE',
                schema: 'public',
                table: 'oxos_presentation_session'
            },
            handleSessionUpdate
        )
        .subscribe();

    console.log('OXOS Real-time subscription active');

    // Don't auto-sync when first joining - user must be present from the start
    // If presentation is already in progress, new users will see the intro screen
    // and only sync when they see real-time updates (someone clicks Next)
    console.log('Current session state:', data.current_slide);
    if (data.current_slide > -1) {
        console.log('Presentation already in progress - waiting for real-time updates');
    }
}

// ===== SUPABASE SYNC FUNCTIONS =====
async function updateSession(updates) {
    const { error } = await supabaseClient
        .from('oxos_presentation_session')
        .update(updates)
        .eq('id', sessionId);

    if (error) {
        console.error('Error updating OXOS session:', error);
    }
}

function handleSessionUpdate(payload) {
    const newData = payload.new;
    console.log('Presentation session updated:', newData);

    // Sync to new slide
    if (newData.current_slide !== currentSlide) {
        syncToSlide(newData.current_slide);
    }
}

function syncToSlide(targetSlide) {
    // Set flag to prevent loop
    isLocalAction = true;

    // Only sync if moving forward by 1 (normal progression)
    // or going back to -1 (restart)
    const diff = targetSlide - currentSlide;

    if (diff === 1) {
        // Normal next slide progression
        nextSlideLocal();
    } else if (targetSlide === -1 && currentSlide !== -1) {
        // Restart to beginning
        restartPresentationLocal();
    }
    // Ignore other cases - user wasn't present from the start

    // Reset flag
    isLocalAction = false;
}
